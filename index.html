<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sự Thật hay Hư Cấu - AI Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; touch-action: manipulation; }
        .card-enter { opacity: 0; transform: translateY(20px) scale(0.95); }
        .card-enter-active { opacity: 1; transform: translateY(0) scale(1); transition: opacity 300ms, transform 300ms; }
        .feedback-correct { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.6); }
        .feedback-incorrect { box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.6); }
        .spinner { width: 40px; height: 40px; border: 5px solid rgba(0, 0, 0, 0.1); border-left-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .topic-btn, .level-btn { transition: all 0.2s ease-in-out; }
        .topic-btn:hover, .level-btn:hover { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .markdown-content h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; }
        .dark .markdown-content h3 { color: inherit; }
        .markdown-content ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; }
        .markdown-content li { margin-bottom: 4px; }
        .markdown-content strong { color: #1e293b; }
        .dark .markdown-content strong { color: #cbd5e1; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 50; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; transform: scale(0.95) translateY(10px); transition: transform 0.3s ease; position: relative; }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        .dark .modal-content { background: #1e293b; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e2e8f0; border-radius: 9999px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
        .dark .modal-close-btn { background: #334155; }
        .modal-close-btn:hover { background: #cbd5e1; }
        .dark .modal-close-btn:hover { background: #475569; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 flex items-center justify-center min-h-screen p-4 transition-colors duration-500">
    
    <div id="auth-loading-overlay" class="fixed inset-0 bg-slate-100 dark:bg-slate-900 z-50 flex flex-col items-center justify-center">
        <div class="spinner"></div>
        <p class="mt-4 text-slate-600 dark:text-slate-300">Đang kết nối...</p>
    </div>

    <div id="game-container" class="w-full max-w-2xl mx-auto">
        <div id="question-card" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-300">
            <div id="start-screen" class="text-center">
                 <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">Sự Thật hay Hư Cấu</h1>
                <p class="text-slate-600 dark:text-slate-300 mb-8">Trò chơi kiến thức được tạo bởi AI Vision</p>
                
                <div id="topic-selection-screen">
                    <h2 class="text-xl font-semibold mb-6">Bước 1: Chọn một chủ đề</h2>
                    <div id="topic-selection" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="level-selection-screen" class="hidden">
                    <h2 class="text-xl font-semibold mb-6">Bước 2: Chọn trình độ</h2>
                    <div class="space-y-4">
                        <button onclick="selectLevel('easy')" class="level-btn w-full text-lg font-bold py-4 px-6 rounded-lg bg-green-500 text-white">Cấp 1 <span class="font-normal text-sm block">(6-10 tuổi)</span></button>
                        <button onclick="selectLevel('medium')" class="level-btn w-full text-lg font-bold py-4 px-6 rounded-lg bg-blue-500 text-white">Phổ thông <span class="font-normal text-sm block">(Mọi lứa tuổi)</span></button>
                        <button onclick="selectLevel('hard')" class="level-btn w-full text-lg font-bold py-4 px-6 rounded-lg bg-red-500 text-white">Chuyên sâu <span class="font-normal text-sm block">(Thử thách)</span></button>
                    </div>
                     <button onclick="backToTopicSelection()" class="mt-6 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Quay lại chọn chủ đề</button>
                </div>
            </div>

            <div id="game-ui" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <button onclick="backToMenu()" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Quay lại</button>
                        <h1 id="game-title" class="text-xl md:text-2xl font-bold text-indigo-600 dark:text-indigo-400">Chủ đề: Ngẫu nhiên</h1>
                    </div>
                    <div id="score" class="text-lg font-semibold bg-slate-200 dark:bg-slate-700 px-4 py-1 rounded-full">Điểm: 0</div>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
                    <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="question-number" class="text-sm text-slate-500 dark:text-slate-400 mb-2 font-medium"></p>
                <div id="image-container" class="w-full h-48 md:h-64 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4 flex items-center justify-center overflow-hidden hidden">
                    <div id="image-spinner" class="spinner"></div>
                    <img id="question-image" src="" alt="Hình ảnh minh họa" class="w-full h-full object-cover hidden transition-opacity duration-500">
                </div>
                <div id="question-area" class="min-h-[100px] md:min-h-[120px] flex items-center justify-center">
                    <h2 id="question-text" class="text-xl md:text-2xl text-center font-semibold"></h2>
                    <div id="loading-spinner" class="spinner hidden"></div>
                </div>
                <div id="explanation-container" class="text-slate-600 dark:text-slate-300 mt-4 p-4 bg-slate-100 dark:bg-slate-700 rounded-lg min-h-[50px] hidden">
                    <div id="explanation-content" class="markdown-content"></div>
                    <button id="learn-more-btn" onclick="openLearnMoreModal()" class="mt-3 text-sm font-semibold text-indigo-600 dark:text-indigo-400 hover:underline">Tìm hiểu sâu hơn &rarr;</button>
                </div>
                <div id="button-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                    <button id="true-btn" onclick="checkAnswer(true)" class="w-full text-lg font-bold py-4 px-6 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600">Sự Thật</button>
                    <button id="false-btn" onclick="checkAnswer(false)" class="w-full text-lg font-bold py-4 px-6 rounded-lg bg-rose-500 text-white hover:bg-rose-600">Hư Cấu</button>
                    <button id="next-btn" onclick="goToNextQuestion()" class="hidden sm:col-span-2 w-full text-lg font-bold py-4 px-6 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Câu tiếp theo</button>
                </div>
            </div>

            <div id="final-score" class="text-center hidden">
                <h2 id="final-title" class="text-3xl md:text-4xl font-bold mb-4">Hoàn thành!</h2>
                <p class="text-xl mb-2">Điểm cuối cùng của bạn:</p>
                <p id="final-score-text" class="text-6xl font-bold text-indigo-600 dark:text-indigo-400 mb-8">0</p>
                <p id="final-message" class="text-lg mb-8"></p>
                <button onclick="resetGame()" class="w-full sm:w-auto text-lg font-bold py-4 px-8 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Chơi Lại</button>
            </div>
        </div>
    </div>

    <div id="learn-more-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeLearnMoreModal()" class="modal-close-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-slate-600 dark:text-slate-300" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-indigo-600 dark:text-indigo-400">Khám Phá Sâu Hơn</h2>
            <div id="modal-spinner" class="flex justify-center my-8"><div class="spinner"></div></div>
            <div id="modal-content-area" class="markdown-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-ai.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, serverTimestamp, getDoc, increment } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQj9JpV0w3fbfLXWqEaeJ2QkAnnMyeCwU",
            authDomain: "allinone-2b180.firebaseapp.com",
            projectId: "allinone-2b180",
            storageBucket: "allinone-2b180.firebasestorage.app",
            messagingSenderId: "147236185680",
            appId: "1:147236185680:web:dde77438ff630e3210d355"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let textModel;
        
        const createQuizTool = { functionDeclarations: [{ name: "create_quiz_question", description: "Tạo một câu đố 'Sự thật hay Hư cấu' (Fact or Fiction).", parameters: { type: "OBJECT", properties: { statement: { type: "STRING", description: "Phát biểu của câu đố, để người dùng xác định là đúng hay sai." }, answer: { type: "BOOLEAN", description: "Đáp án đúng, true cho 'Sự thật', false cho 'Hư cấu'." }, explanation: { type: "STRING", description: "Một lời giải thích chi tiết khoảng 2-3 câu, cung cấp bối cảnh và thông tin thú vị liên quan. Sử dụng Markdown đơn giản để định dạng." }, image_prompt: { type: "STRING", description: "Một mô tả ngắn gọn, nghệ thuật bằng tiếng Anh để AI tạo hình ảnh minh họa." } }, required: ["statement", "answer", "explanation", "image_prompt"] } }] };
        try {
            // **SỬA LỖI**: Sửa lỗi đánh máy tên model
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            textModel = getGenerativeModel(ai, { model: "gemini-2.0-flash-lite", tools: createQuizTool, toolConfig: { functionCallingConfig: { mode: "ANY" } } });
        } catch (e) { console.error("Lỗi khi khởi tạo Text Model:", e); }
        
        const TOTAL_QUESTIONS_PER_GAME = 10;
        const PIONEER_THRESHOLD = 50; // Ngưỡng chất lượng
        const topics = [
            { id: 'random', name: 'Ngẫu nhiên', prompt: 'bất kỳ', color: 'bg-slate-500', subtopics: [] },
            { id: 'space', name: 'Vũ trụ', prompt: 'khoa học vũ trụ', color: 'bg-indigo-500', subtopics: ['Các hành tinh trong Hệ Mặt Trời', 'Lỗ đen và các hiện tượng kỳ lạ', 'Lịch sử du hành vũ trụ', 'Các loại thiên hà và tinh vân', 'Các ngôi sao và vòng đời của chúng'] },
            { id: 'animals', name: 'Động vật', prompt: 'thế giới động vật', color: 'bg-green-500', subtopics: ['Động vật có vú', 'Loài bò sát và lưỡng cư', 'Sinh vật biển', 'Côn trùng và thế giới tí hon', 'Các loài đã tuyệt chủng'] },
            { id: 'history', name: 'Lịch sử', prompt: 'lịch sử thế giới', color: 'bg-amber-600', subtopics: ['Các nền văn minh cổ đại', 'Các cuộc chiến tranh thế giới', 'Các phát minh thay đổi lịch sử', 'Những nhân vật lịch sử bí ẩn', 'Lịch sử Việt Nam'] },
            { id: 'tech', name: 'Công nghệ', prompt: 'công nghệ và phát minh', color: 'bg-sky-500', subtopics: ['Lịch sử máy tính và internet', 'Trí tuệ nhân tạo (AI)', 'Công nghệ ngoài không gian', 'Các thiết bị công nghệ đột phá', 'An ninh mạng và hacker'] },
            { id: 'myth', name: 'Thần thoại', prompt: 'thần thoại và truyền thuyết', color: 'bg-purple-500', subtopics: ['Thần thoại Hy Lạp và La Mã', 'Thần thoại Ai Cập', 'Thần thoại Bắc Âu', 'Các sinh vật huyền thoại', 'Truyền thuyết đô thị hiện đại'] },
            { id: 'geography', name: 'Địa lý', prompt: 'địa lý thế giới', color: 'bg-emerald-500', subtopics: ['Các kỳ quan thiên nhiên thế giới', 'Những con sông và ngọn núi cao nhất', 'Các hiện tượng thời tiết cực đoan', 'Các sa mạc và rừng rậm lớn nhất', 'Địa lý các quốc gia đặc biệt'] },
        ];
        
        let userId = null;
        let userHistory = [];
        let generationRetryCount = 0;
        let questionCounts = {};

        let currentQuestionIndex = 0;
        let score = 0;
        let currentQuestion = null;
        let selectedTopic = topics[0];
        let selectedLevel = 'medium';

        const domElements = {
            authLoadingOverlay: document.getElementById('auth-loading-overlay'),
            startScreen: document.getElementById('start-screen'),
            topicSelectionScreen: document.getElementById('topic-selection-screen'),
            levelSelectionScreen: document.getElementById('level-selection-screen'),
            questionCard: document.getElementById('question-card'),
            questionText: document.getElementById('question-text'),
            questionNumberText: document.getElementById('question-number'),
            scoreText: document.getElementById('score'),
            explanationContainer: document.getElementById('explanation-container'),
            explanationContent: document.getElementById('explanation-content'),
            buttonContainer: document.getElementById('button-container'),
            progressBar: document.getElementById('progress-bar'),
            loadingSpinner: document.getElementById('loading-spinner'),
            gameUI: document.getElementById('game-ui'),
            finalScoreScreen: document.getElementById('final-score'),
            finalScoreText: document.getElementById('final-score-text'),
            finalMessage: document.getElementById('final-message'),
            topicSelectionContainer: document.getElementById('topic-selection'),
            gameTitle: document.getElementById('game-title'),
            trueBtn: document.getElementById('true-btn'),
            falseBtn: document.getElementById('false-btn'),
            nextBtn: document.getElementById('next-btn'),
            imageContainer: document.getElementById('image-container'),
            imageSpinner: document.getElementById('image-spinner'),
            questionImage: document.getElementById('question-image'),
            learnMoreModal: document.getElementById('learn-more-modal'),
            modalSpinner: document.getElementById('modal-spinner'),
            modalContentArea: document.getElementById('modal-content-area')
        };
        
        async function loadMetadata() {
            const metadataRef = doc(db, '_metadata', 'questionCounts');
            try {
                const docSnap = await getDoc(metadataRef);
                if (docSnap.exists()) {
                    questionCounts = docSnap.data();
                    console.log("Metadata đã tải:", questionCounts);
                } else {
                    console.log("Chưa có metadata, sẽ được tạo mới.");
                }
            } catch (error) {
                console.error("Lỗi khi tải metadata:", error);
            }
        }

        async function updateQuestionCount(topic, level) {
            const countKey = `${topic.id}_${level}`;
            const metadataRef = doc(db, '_metadata', 'questionCounts');
            try {
                await setDoc(metadataRef, { [countKey]: increment(1) }, { merge: true });
                questionCounts[countKey] = (questionCounts[countKey] || 0) + 1;
            } catch(error) {
                console.error("Lỗi khi cập nhật bộ đếm:", error);
            }
        }

        async function loadUserHistory() {
            if (!userId) return;
            userHistory = [];
            const historyCollectionRef = collection(db, 'users', userId, 'gameHistory');
            try {
                const querySnapshot = await getDocs(historyCollectionRef);
                querySnapshot.forEach(doc => userHistory.push(doc.id));
            } catch (error) { console.error("Lỗi khi tải lịch sử người dùng:", error); }
        }
        
        async function updateUserHistory(questionId, topicId) {
            if (!userId || !questionId || !topicId) return;
            const historyDocId = `${topicId}_${questionId}`;
            const historyDocRef = doc(db, 'users', userId, 'gameHistory', historyDocId);
            try {
                await setDoc(historyDocRef, { playedAt: serverTimestamp() });
                if (!userHistory.includes(historyDocId)) userHistory.push(historyDocId);
            } catch (error) { console.error("Lỗi khi cập nhật lịch sử người dùng:", error); }
        }
        
        async function getAvailableQuestionIds(topic, level) {
            const collectionName = `${topic.id}_questions`;
            const q = query(collection(db, collectionName), where("level", "==", level));
            try {
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.id);
            } catch (error) { return []; }
        }

        async function isQuestionDuplicate(statement, topic) {
            const collectionName = `${topic.id}_questions`;
            const q = query(collection(db, collectionName), where("statement", "==", statement));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        }

        async function generateWithAI(topic, level) {
            let difficultyInstruction = '';
            switch(level) {
                case 'easy': difficultyInstruction = 'Câu hỏi phải cực kỳ đơn giản, phù hợp cho trẻ em 6-10 tuổi.'; break;
                case 'hard': difficultyInstruction = 'Câu hỏi phải ở mức độ khó, dành cho người có kiến thức chuyên sâu.'; break;
                default: difficultyInstruction = 'Câu hỏi ở mức độ kiến thức phổ thông, phù hợp với mọi lứa tuổi.'; break;
            }
            const historyForAI = userHistory.map(h => h.split('_')[1]);
            const historyContext = historyForAI.length > 0 ? `Quan trọng: Câu hỏi mới phải hoàn toàn khác biệt với những câu đã có trong lịch sử.` : "";
            const prompt = `Tạo một câu đố 'Sự thật hay Hư cấu' bằng tiếng Việt. Chủ đề: "${topic.prompt}". Độ khó: "${difficultyInstruction}". ${historyContext}`;
            try {
                const result = await textModel.generateContent(prompt);
                const functionCalls = result.response.functionCalls();
                if (functionCalls && functionCalls[0]?.name === "create_quiz_question") return functionCalls[0].args;
                throw new Error("AI không gọi hàm.");
            } catch (error) { console.error("Lỗi khi AI tạo câu hỏi:", error); return null; }
        }
        
        async function saveQuestionToCache(questionData, topic, level) {
            const collectionName = `${topic.id}_questions`;
            try {
                const docRef = await addDoc(collection(db, collectionName), { ...questionData, level: level, createdAt: serverTimestamp() });
                return docRef.id;
            } catch (error) { console.error(`Lỗi khi lưu câu hỏi:`, error); return null; }
        }
        
        async function generateUniqueAIQuestion(topic, level) {
             console.log("Chế độ Người Tiên Phong: Đang tạo câu hỏi độc nhất...");
             let uniqueQuestionData = null;
             let newId = null;
             let attempts = 0;
             while(attempts < 5 && !uniqueQuestionData) {
                 attempts++;
                 const aiData = await generateWithAI(topic, level);
                 if (aiData) {
                     const isDuplicate = await isQuestionDuplicate(aiData.statement, topic);
                     if (!isDuplicate) {
                         newId = await saveQuestionToCache(aiData, topic, level);
                         if (newId) {
                            await updateQuestionCount(topic, level);
                            uniqueQuestionData = { id: newId, topicId: topic.id, ...aiData };
                         }
                     } else {
                         console.warn("AI đã tạo câu hỏi trùng lặp, đang thử lại...");
                     }
                 }
             }
             return uniqueQuestionData;
        }

        async function fetchNextQuestion() {
            showLoading(true);
            const currentTopic = selectedTopic.id === 'random' ? topics[Math.floor(Math.random() * (topics.length - 1)) + 1] : selectedTopic;
            
            const countKey = `${currentTopic.id}_${selectedLevel}`;
            const currentCount = questionCounts[countKey] || 0;

            if (currentCount < PIONEER_THRESHOLD) {
                const question = await generateUniqueAIQuestion(currentTopic, selectedLevel);
                 if (question) {
                     showLoading(false);
                     return question;
                 }
                 console.warn("Không thể tạo câu hỏi độc nhất, chuyển về chế độ Kế Thừa.");
            }
            
            const allAvailableIds = await getAvailableQuestionIds(currentTopic, selectedLevel);
            const playedIdsForTopic = userHistory.filter(id => id.startsWith(`${currentTopic.id}_`)).map(id => id.split('_')[1]);
            const unseenIds = allAvailableIds.filter(id => !playedIdsForTopic.includes(id));
            
            if (unseenIds.length > 0) {
                const randomId = unseenIds[Math.floor(Math.random() * unseenIds.length)];
                const questionDocRef = doc(db, `${currentTopic.id}_questions`, randomId);
                const docSnap = await getDoc(questionDocRef);
                if (docSnap.exists()) {
                    console.log(`Chế độ Kế Thừa: Lấy câu hỏi từ cache: ${currentTopic.id}/${randomId}`);
                    showLoading(false);
                    return { id: docSnap.id, topicId: currentTopic.id, ...docSnap.data() };
                }
            }
            
            const question = await generateUniqueAIQuestion(currentTopic, selectedLevel);
            if(question) {
                showLoading(false);
                return question;
            }

            domElements.questionText.textContent = "Không thể tải câu hỏi. Vui lòng thử lại.";
            showLoading(false);
            return null;
        }
        
        // **SỬA LỖI**: Thêm lại hàm showLoading bị thiếu
        function showLoading(isLoading) {
            if (isLoading) {
                domElements.questionText.style.display = 'none';
                domElements.loadingSpinner.style.display = 'block';
                domElements.buttonContainer.style.pointerEvents = 'none';
                domElements.buttonContainer.style.opacity = 0.5;
            } else {
                domElements.questionText.style.display = 'block';
                domElements.loadingSpinner.style.display = 'none';
                domElements.buttonContainer.style.pointerEvents = 'auto';
                domElements.buttonContainer.style.opacity = 1;
            }
        }

        async function displayQuestion() {
            domElements.questionCard.classList.remove('card-enter-active', 'feedback-correct', 'feedback-incorrect');
            domElements.questionCard.classList.add('card-enter');
            domElements.explanationContainer.style.display = 'none';
            domElements.trueBtn.style.display = 'block';
            domElements.falseBtn.style.display = 'block';
            domElements.nextBtn.style.display = 'none';
            
            currentQuestion = await fetchNextQuestion();

            if (currentQuestion) {
                domElements.questionText.innerHTML = marked.parseInline(currentQuestion.statement);
                domElements.questionNumberText.textContent = `Câu hỏi ${currentQuestionIndex + 1} trên ${TOTAL_QUESTIONS_PER_GAME}`;
                domElements.progressBar.style.width = `${((currentQuestionIndex + 1) / TOTAL_QUESTIONS_PER_GAME) * 100}%`;
                domElements.questionCard.classList.add('card-enter-active');
                updateUserHistory(currentQuestion.id, currentQuestion.topicId);
            }
        }
        function startGame() {
            currentQuestionIndex = 0;
            score = 0;
            updateScore();
            displayQuestion();
        }
        function initAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await loadUserHistory();
                    await loadMetadata();
                } else {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        userId = userCredential.user.uid;
                        await loadUserHistory();
                        await loadMetadata();
                    } catch (error) {
                        domElements.authLoadingOverlay.innerHTML = '<p class="text-red-500 font-semibold">Lỗi kết nối.</p>';
                        return;
                    }
                }
                domElements.authLoadingOverlay.style.display = 'none';
            });
        }
        function init() {
            topics.forEach(topic => {
                const button = document.createElement('button');
                button.textContent = topic.name;
                button.className = `topic-btn w-full text-lg font-bold py-6 px-4 rounded-lg text-white ${topic.color}`;
                button.onclick = () => selectTopic(topic.id);
                domElements.topicSelectionContainer.appendChild(button);
            });
            domElements.learnMoreModal.addEventListener('click', (event) => {
                if (event.target === domElements.learnMoreModal) closeLearnMoreModal();
            });
            initAuth();
        }
        window.backToMenu = () => {
            domElements.gameUI.style.display = 'none';
            domElements.finalScoreScreen.style.display = 'none';
            domElements.startScreen.style.display = 'block';
            domElements.levelSelectionScreen.style.display = 'none';
            domElements.topicSelectionScreen.style.display = 'block';
        };
        window.selectTopic = (id) => { selectedTopic = topics.find(t => t.id === id); domElements.topicSelectionScreen.style.display = 'none'; domElements.levelSelectionScreen.style.display = 'block'; };
        window.selectLevel = (level) => { selectedLevel = level; domElements.startScreen.style.display = 'none'; domElements.gameUI.style.display = 'block'; domElements.gameTitle.textContent = `Chủ đề: ${selectedTopic.name}`; startGame(); };
        window.backToTopicSelection = () => { domElements.levelSelectionScreen.style.display = 'none'; domElements.topicSelectionScreen.style.display = 'block'; };
        window.resetGame = function() { domElements.finalScoreScreen.style.display = 'none'; backToMenu(); };
        window.checkAnswer = function(userAnswer){if(!currentQuestion)return;domElements.trueBtn.style.display='none';domElements.falseBtn.style.display='none';domElements.nextBtn.style.display='block';const t=currentQuestion.answer===userAnswer;t?(score++,domElements.questionCard.classList.add("feedback-correct")):domElements.questionCard.classList.add("feedback-incorrect"),updateScore(),showExplanation()};
        window.goToNextQuestion = function(){currentQuestionIndex++,currentQuestionIndex<TOTAL_QUESTIONS_PER_GAME?displayQuestion():showFinalScore()};
        function showExplanation(){const e=currentQuestion.answer===!0?"### ✅ Đúng vậy, đó là Sự thật!":"### ❌ Chính xác, đó là Hư cấu!",t=`${e}\n\n${currentQuestion.explanation}`;domElements.explanationContent.innerHTML=marked.parse(t),domElements.explanationContainer.style.display="block"}
        function updateScore(){domElements.scoreText.innerHTML=`Điểm: ${score}`}
        function showFinalScore(){domElements.gameUI.style.display="none",domElements.finalScoreScreen.style.display="block",domElements.finalScoreText.textContent=score;let e="Cố gắng hơn nhé! Còn nhiều điều thú vị để khám phá.";const t=score/TOTAL_QUESTIONS_PER_GAME*100;100===t?e="Tuyệt vời! Bạn là một bậc thầy sự thật!":t>=75?e="Làm tốt lắm! Kiến thức của bạn thật đáng nể.":t>=50&&(e="Không tệ! Bạn đã phân biệt được khá nhiều sự thật."),domElements.finalMessage.textContent=e}
        window.openLearnMoreModal=async()=>{domElements.learnMoreModal.classList.add("active"),domElements.modalContentArea.innerHTML="",domElements.modalSpinner.style.display="flex";const e=await generateDetailedExplanation();domElements.modalSpinner.style.display="none",e?domElements.modalContentArea.innerHTML=marked.parse(e):domElements.modalContentArea.innerHTML=`\n                    <div class="text-center">\n                        <p class="text-red-500 font-semibold">Rất tiếc, không thể tạo nội dung.</p>\n                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Đã có lỗi xảy ra trong quá trình xử lý. Vui lòng thử lại.</p>\n                        <button onclick="openLearnMoreModal()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-semibold">\n                            Thử lại\n                        </button>\n                    </div>\n                `};
        async function generateDetailedExplanation(){if(!textModel||!currentQuestion)return null;const e=getGenerativeModel(getAI(app,{backend:new GoogleAIBackend}),{model:"gemini-2.0-flash-lite"}),t=`Hãy đóng vai một chuyên gia uyên bác. Dựa trên phát biểu sau: "${currentQuestion.statement}", hãy cung cấp một bài giải thích chi tiết, sâu sắc và thú vị bằng tiếng Việt. Mở rộng từ lời giải thích ngắn gọn ban đầu: "${currentQuestion.explanation}". Đi sâu vào chi tiết, bối cảnh, hoặc các khái niệm khoa học liên quan. Sử dụng định dạng Markdown.`;try{const n=await e.generateContent(t);return n.response.text()}catch(n){return console.error("Lỗi khi tạo giải thích chi tiết:",n),null}}
        window.closeLearnMoreModal = () => domElements.learnMoreModal.classList.remove('active');

        init();
    </script>
</body>
</html>

